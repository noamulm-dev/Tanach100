(function(){"use strict";var e=(t=>(t.Torah="תורה",t.Nevim="נביאים",t.Ketuvim="כתובים",t))(e||{});const y=[{id:"Genesis",name:"בראשית",section:e.Torah,chaptersCount:50},{id:"Exodus",name:"שמות",section:e.Torah,chaptersCount:40},{id:"Leviticus",name:"ויקרא",section:e.Torah,chaptersCount:27},{id:"Numbers",name:"במדבר",section:e.Torah,chaptersCount:36},{id:"Deuteronomy",name:"דברים",section:e.Torah,chaptersCount:34},{id:"Joshua",name:"יהושע",section:e.Nevim,chaptersCount:24},{id:"Judges",name:"שופטים",section:e.Nevim,chaptersCount:21},{id:"I Samuel",name:"שמואל א",section:e.Nevim,chaptersCount:31},{id:"II Samuel",name:"שמואל ב",section:e.Nevim,chaptersCount:24},{id:"I Kings",name:"מלכים א",section:e.Nevim,chaptersCount:22},{id:"II Kings",name:"מלכים ב",section:e.Nevim,chaptersCount:25},{id:"Isaiah",name:"ישעיהו",section:e.Nevim,chaptersCount:66},{id:"Jeremiah",name:"ירמיהו",section:e.Nevim,chaptersCount:52},{id:"Ezekiel",name:"יחזקאל",section:e.Nevim,chaptersCount:48},{id:"Hosea",name:"הושע",section:e.Nevim,chaptersCount:14},{id:"Joel",name:"יואל",section:e.Nevim,chaptersCount:4},{id:"Amos",name:"עמוס",section:e.Nevim,chaptersCount:9},{id:"Obadiah",name:"עובדיה",section:e.Nevim,chaptersCount:1},{id:"Jonah",name:"יונה",section:e.Nevim,chaptersCount:4},{id:"Micah",name:"מיכה",section:e.Nevim,chaptersCount:7},{id:"Nahum",name:"נחום",section:e.Nevim,chaptersCount:3},{id:"Habakkuk",name:"חבקוק",section:e.Nevim,chaptersCount:3},{id:"Zephaniah",name:"צפניה",section:e.Nevim,chaptersCount:3},{id:"Haggai",name:"חגי",section:e.Nevim,chaptersCount:2},{id:"Zechariah",name:"זכריה",section:e.Nevim,chaptersCount:14},{id:"Malachi",name:"מלאכי",section:e.Nevim,chaptersCount:3},{id:"Psalms",name:"תהילים",section:e.Ketuvim,chaptersCount:150},{id:"Proverbs",name:"משלי",section:e.Ketuvim,chaptersCount:31},{id:"Job",name:"איוב",section:e.Ketuvim,chaptersCount:42},{id:"Song of Songs",name:"שיר השירים",section:e.Ketuvim,chaptersCount:8},{id:"Ruth",name:"רות",section:e.Ketuvim,chaptersCount:4},{id:"Lamentations",name:"איכה",section:e.Ketuvim,chaptersCount:5},{id:"Ecclesiastes",name:"קהלת",section:e.Ketuvim,chaptersCount:12},{id:"Esther",name:"אסתר",section:e.Ketuvim,chaptersCount:10},{id:"Daniel",name:"דניאל",section:e.Ketuvim,chaptersCount:12},{id:"Ezra",name:"עזרא",section:e.Ketuvim,chaptersCount:10},{id:"Nehemiah",name:"נחמיה",section:e.Ketuvim,chaptersCount:13},{id:"I Chronicles",name:"דברי הימים א",section:e.Ketuvim,chaptersCount:29},{id:"II Chronicles",name:"דברי הימים ב",section:e.Ketuvim,chaptersCount:36}],Q="TanakhDB",P="verses",V=1,X=(t,n,c,o)=>{console.info(`%c[BibleService] %c${t}: %c${n}`,"color: #6366f1; font-weight: bold","color: gray",`color: ${c}; font-weight: bold`,o||"")},Y=()=>new Promise((t,n)=>{const c=indexedDB.open(Q,V);c.onupgradeneeded=()=>{const o=c.result;o.objectStoreNames.contains(P)||o.createObjectStore(P,{keyPath:"id"})},c.onsuccess=()=>t(c.result),c.onerror=()=>n(c.error)});function O(t){if(!t)return"";let n=t;return n=n.replace(/&nbsp;/g," ").replace(/&lt;/g,"").replace(/&gt;/g,"").replace(/&amp;/g,""),n=n.replace(/<[^>]*>/g,""),n=n.replace(/[\(\[\{].*?[\)\]\}]/g,""),n=n.replace(/[\u0591-\u05AF\u05BD\u05BF\u05C0\u05C4\u05C5\u05C6]/g,""),n=n.replace(/\u05BE/g," "),n=n.replace(/[\u05C6\-\.,:;!\?\|\u2010-\u2027]/g," "),n=n.replace(/[^\u05D0-\u05EA\u05B0-\u05BC\u05C1\u05C2\u05C3\u05C7\s]/g,""),n.replace(/\s+/g," ").trim()}function q(t){return t?typeof t=="string"?[t]:Array.isArray(t)?t.flatMap(n=>q(n)):[]:[]}function ee(t){return t.replace(/ /g,"_")}async function te(t,n,c){X("Fetching Chapter","Sefaria API (Remote)","#f59e0b",{bookName:t,chapterNum:n});try{const o=await fetch(`https://www.sefaria.org/api/texts/${t}.${n}?context=0`,{signal:c});if(!o.ok)return[];const v=await o.json();return q(v.he)}catch(o){if(o.name==="AbortError")throw o;return console.warn(`Failed to fetch chapter ${t} ${n} from Sefaria`,o),[]}}const ne=async(t,n)=>{var c;try{const v=(await Y()).transaction(P,"readonly").objectStore(P).get(`${t.id}_${n}`),h=await new Promise(T=>v.onsuccess=()=>T(v.result));if((c=h==null?void 0:h.verses)!=null&&c.length)return h.verses.map((T,_)=>({book:t.name,chapter:n,verse:_+1,text:T}))}catch{}try{const o=await te(ee(t.id),n);if(o.length>0)return o.map((v,h)=>({book:t.name,chapter:n,verse:h+1,text:O(v)}))}catch(o){console.error("Network Fetch failed",o)}return[{book:t.name,chapter:n,verse:1,text:"שגיאה בטעינת הפרק. אנא בדוק חיבור לרשת או בצע סנכרון מלא."}]},se=async t=>{const n=y.find(o=>o.id===t);if(!n)return[];const c=[];for(let o=1;o<=n.chaptersCount;o++)c.push(await ne(n,o));return c},F=t=>t.replace(/[^א-ת]/g,""),J=t=>{switch(t){case"ך":return"כ";case"ם":return"מ";case"ן":return"נ";case"ף":return"פ";case"ץ":return"צ";default:return t}};self.onmessage=async t=>{if(t.data.type==="START"){const{query:n,wholeWord:c,scope:o,currentBookId:v}=t.data.payload;try{const h=n.trim();if(!h){self.postMessage({type:"RESULTS",results:[],regularSearchEnabled:!1});return}const T=h.includes("+"),oe=h.replace(/\+/g,"").split(",").map(s=>s.trim()).filter(s=>s.length>0),S=[],L=[];oe.forEach(s=>{const a=s.match(/^(-?\d+)-(-?\d+)$/);if(a){const i=parseInt(a[1],10),m=parseInt(a[2],10);if(!isNaN(i)&&!isNaN(m)){const B=Math.min(i,m),N=Math.max(i,m);for(let p=B;p<=N;p++)p!==0&&L.push(p);return}}const r=parseInt(s,10);!isNaN(r)&&/^-?\d+$/.test(s)?r!==0&&L.push(r):S.push(s)});const R=Array.from(new Set(L)),re=R.length>0,ae=R.includes(1)||R.includes(-1),W=S.length>0&&(!re||ae);let E=[];R.filter(s=>Math.abs(s)>1).forEach(s=>{E.push(s),T||E.push(-s)}),E=Array.from(new Set(E));const ce=S.length>0&&E.length>0;let b=[];if(o==="current"){const s=y.find(a=>a.id===v);s&&(b=[s])}else o==="torah"?b=y.filter(s=>s.section===e.Torah):b=y;const z=await Promise.all(b.map(s=>se(s.id))),$=[];if(W){const s=S.length>1?S.filter(r=>F(r).length>=2):S,a=s.map(r=>{const i=r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");return/[\u0591-\u05C7]/.test(r)?i+"[\\u0591-ׇ]*":i.split("").join("[\\u0591-ׇ]*")+"[\\u0591-ׇ]*"});if(a.length>0){let r=`(${a.join("|")})`;c&&(r="(?<![\\u05D0-\\u05EA\\u0591-\\u05C7])"+r+"(?![\\u05D0-\\u05EA\\u0591-\\u05C7])");const i=new RegExp(r,"g");z.forEach((m,B)=>{const N=b[B];m.forEach((p,d)=>{p.forEach((M,x)=>{const f=M.text;Array.from(f.matchAll(i)).forEach((w,A)=>{const l=w[0],k=w.index,I=f.substring(0,k),C=O(I).replace(/[^א-ת]/g,"").length,u=O(l).replace(/[^א-ת]/g,""),j=u.length,U=s.findIndex(D=>{const Z=F(D);return u.includes(Z)||Z.includes(u)}),ie=U===-1?99:100+U,G=[];for(let D=0;D<j;D++)G.push({bookId:N.id,chapter:d+1,verse:x+1,letterIdx:C+D,groupId:ie});$.push({bookId:N.id,chapter:d+1,verse:x+1,text:l,occurrenceIndex:A,elsSkip:1,elsComponents:G})})})})})}}if(ce){const s=[];S.forEach(r=>s.push(...r.split(/\s+/)));const a=s.map(r=>F(r)).filter(r=>r.length>=2);if(a.length>0){let r="";const i=[];z.forEach((d,M)=>{const x=b[M];d.forEach((f,K)=>{f.forEach((w,A)=>{const l=w.text;let k=0;for(let I=0;I<l.length;I++){const g=l[I];g>="א"&&g<="ת"&&(i.push({bookId:x.id,chapter:K+1,verse:A+1,letterIdx:k++,globalIdx:i.length}),r+=g)}})})});const m=new Set,B=a.length*E.length;let N=0,p=Date.now();a.forEach((d,M)=>{const x=d.split("").map(J).join("");E.forEach(f=>{N++;const K=Date.now();if(K-p>100){const l=Math.round(N/B*100);self.postMessage({type:"PROGRESS",percent:l}),p=K}const w=Math.abs(f),A=M*10+w%10;for(let l=0;l<r.length;l++){const k=l+(d.length-1)*f;if(k<0||k>=r.length)continue;let I=!0;const g=[];for(let C=0;C<d.length;C++){const u=l+C*f;if(J(r[u])!==x[C]){I=!1;break}g.push({...i[u],groupId:A})}if(I){const C=g.map(u=>u.globalIdx).sort((u,j)=>u-j).join(",");if(!m.has(C)){m.add(C);const u=g[0];$.push({bookId:u.bookId,chapter:u.chapter,verse:u.verse,text:d,occurrenceIndex:0,elsSkip:f,elsComponents:g})}}}})})}}const H=new Map(y.map((s,a)=>[s.id,a]));$.sort((s,a)=>{const r=H.get(s.bookId)??0,i=H.get(a.bookId)??0;return r!==i?r-i:s.chapter!==a.chapter?s.chapter-a.chapter:s.verse!==a.verse?s.verse-a.verse:s.elsComponents&&a.elsComponents&&s.elsComponents.length>0&&a.elsComponents.length>0?s.elsComponents[0].letterIdx-a.elsComponents[0].letterIdx:0}),self.postMessage({type:"RESULTS",results:$,regularSearchEnabled:W})}catch(h){self.postMessage({type:"ERROR",error:String(h)})}}}})();
